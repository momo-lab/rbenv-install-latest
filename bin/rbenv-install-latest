#!/usr/bin/env bash
set -e
[ -n "$RBENV_DEBUG" ] && set -b

DEFAULT_QUERY=2

# require plugin check
# ref) https://github.com/toy/rbenv-update-rubies/blob/master/bin/rbenv-update-rubies
require_plugin() {
  local name=$1
  local url=$2
  if [[ ! -d "$RBENV_ROOT/plugins/$name" ]]; then
    echo "$name plugin is required, run following command to install:" >&2
    printf "git clone %s %s\n" "$url" "$RBENV_ROOT/plugins/$name" >&2
    exit 1
  fi
}
require_plugin ruby-build https://github.com/rbenv/ruby-build.git

main() {
  local latest=$(get_version $1)
  [[ -z $latest ]] && { echo "Ruby version is not found." >&2; exit 1; }
  if confirm "Install $latest?"; then
    rbenv install $latest
  fi
}

get_version() {
  local query=$1
  [[ -z $query ]] && query=$DEFAULT_QUERY
  rbenv install --list \
    | sed 's/^\s\+//' \
    | grep -vE "(dev|preview|rc)" \
    | grep -E "^$query" \
    | tail -1
}

confirm() {
  local line
  read -p "$1 (y/N)" line
  case "$line" in
    [Yy]*) return 0 ;;
    *) return 1 ;;
  esac
}

main $*
